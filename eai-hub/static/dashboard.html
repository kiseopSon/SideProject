<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EAI Hub - í†µí•© ëŒ€ì‹œë³´ë“œ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-content h1 {
            color: #333;
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header-content p {
            color: #666;
            font-size: 1.1em;
        }

        .logout-btn {
            padding: 10px 20px;
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 600;
            transition: background 0.3s;
        }

        .logout-btn:hover {
            background: #dc2626;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            text-align: center;
        }

        .stat-card h3 {
            color: #666;
            font-size: 0.9em;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .stat-card .value {
            font-size: 2.5em;
            font-weight: bold;
            color: #667eea;
        }

        .services-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
        }

        .service-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .service-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }

        .service-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .service-name {
            font-size: 1.3em;
            font-weight: bold;
            color: #333;
        }

        .service-status {
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: bold;
        }

        .status-healthy {
            background: #10b981;
            color: white;
        }

        .status-unhealthy {
            background: #ef4444;
            color: white;
        }

        .status-unknown {
            background: #6b7280;
            color: white;
        }

        .service-description {
            color: #666;
            margin-bottom: 15px;
            font-size: 0.95em;
        }

        .service-info {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
        }

        .info-badge {
            background: #f3f4f6;
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 0.85em;
            color: #555;
        }

        .service-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 600;
            text-decoration: none;
            display: inline-block;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
        }

        .btn-secondary {
            background: #e5e7eb;
            color: #333;
        }

        .btn-secondary:hover {
            background: #d1d5db;
        }

        .loading {
            text-align: center;
            padding: 50px;
            color: white;
            font-size: 1.2em;
        }

        .refresh-btn {
            position: fixed;
            bottom: 30px;
            right: 30px;
            z-index: 1000;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            font-size: 1.5em;
            cursor: pointer;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            transition: all 0.3s;
        }

        .refresh-btn:hover:not(:disabled) {
            transform: rotate(180deg);
            background: #5568d3;
        }

        .refresh-btn:disabled {
            opacity: 0.7;
            cursor: wait;
        }

        .refresh-btn.loading {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .last-updated {
            text-align: center;
            color: white;
            margin-top: 20px;
            font-size: 0.9em;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-content">
                <h1>ğŸš€ EAI Hub</h1>
                <p>Enterprise Application Integration - í†µí•© ì„œë¹„ìŠ¤ ê´€ë¦¬ ëŒ€ì‹œë³´ë“œ</p>
            </div>
            <button class="logout-btn" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
        </div>

        <div class="stats" id="stats">
            <div class="stat-card">
                <h3>ì „ì²´ ì„œë¹„ìŠ¤</h3>
                <div class="value" id="total-services">-</div>
            </div>
            <div class="stat-card">
                <h3>ì •ìƒ ì„œë¹„ìŠ¤</h3>
                <div class="value" id="healthy-services" style="color: #10b981;">-</div>
            </div>
            <div class="stat-card">
                <h3>ë¹„ì •ìƒ ì„œë¹„ìŠ¤</h3>
                <div class="value" id="unhealthy-services" style="color: #ef4444;">-</div>
            </div>
            <div class="stat-card">
                <h3>í‰ê·  ì‘ë‹µì‹œê°„</h3>
                <div class="value" id="avg-response-time">-</div>
            </div>
        </div>

        <div id="loading" class="loading">ì„œë¹„ìŠ¤ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
        <div class="services-grid" id="services-grid" style="display: none;"></div>
        <div class="last-updated" id="last-updated"></div>
    </div>

    <button class="refresh-btn" onclick="loadServices()" title="ìƒˆë¡œê³ ì¹¨">ğŸ”„</button>

    <script>
        // ì¸ì¦ í™•ì¸ - ë¡œê·¸ì¸í•˜ì§€ ì•Šì•˜ìœ¼ë©´ ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
        async function checkAuth() {
            try {
                const response = await fetch('/api/me', { credentials: 'include' });
                if (response.status === 401) {
                    window.location.href = '/';
                    return false;
                }
                return true;
            } catch (error) {
                console.error('ì¸ì¦ í™•ì¸ ì˜¤ë¥˜:', error);
                return true; // ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ëŠ” ë¬´ì‹œ
            }
        }

        let servicesData = [];
        let healthData = {};
        let userInfo = { username: '', is_admin: false };

        async function loadServices() {
            const refreshBtn = document.querySelector('.refresh-btn');
            if (refreshBtn && !refreshBtn.disabled) {
                refreshBtn.disabled = true;
                refreshBtn.classList.add('loading');
            }

            const isAuthenticated = await checkAuth();
            if (!isAuthenticated) {
                if (refreshBtn) { refreshBtn.disabled = false; refreshBtn.classList.remove('loading'); }
                return;
            }

            try {
                // í˜„ì¬ ì‚¬ìš©ì ì •ë³´ (ìµœê³  ê¶Œí•œ ì—¬ë¶€)
                try {
                    const meRes = await fetch('/api/me', { credentials: 'include' });
                    if (meRes.ok) {
                        const text = await meRes.text();
                        const me = text ? JSON.parse(text) : {};
                        userInfo = { username: me.username || '', is_admin: !!me.is_admin };
                    }
                } catch (e) {
                    userInfo = { username: '', is_admin: false };
                }

                // ì„œë¹„ìŠ¤ ëª©ë¡ ë¡œë“œ
                const servicesResponse = await fetch('/api/services', { credentials: 'include' });
                if (servicesResponse.status === 401) {
                    window.location.href = '/';
                    return;
                }
                const servicesText = await servicesResponse.text();
                const servicesResult = servicesText ? (() => { try { return JSON.parse(servicesText); } catch (_) { return {}; } })() : {};
                servicesData = servicesResult.services || [];

                // í—¬ìŠ¤ì²´í¬ ì •ë³´ ë¡œë“œ
                const healthResponse = await fetch('/api/health', { credentials: 'include' });
                if (healthResponse.status === 401) {
                    window.location.href = '/';
                    return;
                }
                const healthText = await healthResponse.text();
                const healthResult = healthText ? (() => { try { return JSON.parse(healthText); } catch (_) { return {}; } })() : {};
                healthData = healthResult.services || {};

                updateStats(healthResult);
                renderServices();
                document.getElementById('loading').style.display = 'none';
                document.getElementById('services-grid').style.display = 'grid';
                document.getElementById('last-updated').textContent = 
                    `ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸: ${new Date().toLocaleString('ko-KR')}`;
            } catch (error) {
                console.error('ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜:', error);
                document.getElementById('loading').textContent = 'ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
            } finally {
                const btn = document.querySelector('.refresh-btn');
                if (btn) { btn.disabled = false; btn.classList.remove('loading'); }
            }
        }

        function updateStats(healthResult) {
            document.getElementById('total-services').textContent = healthResult.total_services || 0;
            
            // ì •ìƒ/ë¹„ì •ìƒ ì„œë¹„ìŠ¤ ì¹´ìš´íŠ¸ ì¬ê³„ì‚° (ë¹„í™œì„±í™”ëœ ì„œë¹„ìŠ¤ ì œì™¸)
            let healthyCount = 0;
            let unhealthyCount = 0;
            
            servicesData.forEach(service => {
                const health = healthData[service.id] || {};
                const isDesktopDownload = service.type === 'desktop' && service.metadata?.download_file;
                const downloadAvailable = service.download_available === true;
                const isHealthy = service.enabled !== false && health.is_healthy === true;
                // ë‹¤ìš´ë¡œë“œ ì „ìš© ì„œë¹„ìŠ¤ëŠ” ë‹¤ìš´ë¡œë“œ ê°€ëŠ¥ ì‹œ ì •ìƒìœ¼ë¡œ ê°„ì£¼
                const isEffectivelyHealthy = isHealthy || (isDesktopDownload && downloadAvailable);
                if (service.enabled === false) {
                    unhealthyCount++;
                } else if (isEffectivelyHealthy) {
                    healthyCount++;
                } else {
                    unhealthyCount++;
                }
            });
            
            document.getElementById('healthy-services').textContent = healthyCount;
            document.getElementById('unhealthy-services').textContent = unhealthyCount;
            
            // í‰ê·  ì‘ë‹µì‹œê°„ ê³„ì‚°
            let totalTime = 0;
            let count = 0;
            Object.values(healthData).forEach(status => {
                if (status.response_time_ms) {
                    totalTime += status.response_time_ms;
                    count++;
                }
            });
            const avgTime = count > 0 ? Math.round(totalTime / count) : 0;
            document.getElementById('avg-response-time').textContent = avgTime > 0 ? `${avgTime}ms` : '-';
        }

        function renderServices() {
            const grid = document.getElementById('services-grid');
            grid.innerHTML = '';

            servicesData.forEach(service => {
                const health = healthData[service.id] || {};
                // enabledê°€ falseì´ê±°ë‚˜ is_healthyê°€ falseì´ë©´ ë¹„ì •ìƒ
                const isDesktopDownload = service.type === 'desktop' && service.metadata?.download_file;
                const downloadAvailable = service.download_available === true;
                const isHealthy = service.enabled !== false && health.is_healthy === true;
                // ë‹¤ìš´ë¡œë“œ ì „ìš© ì„œë¹„ìŠ¤ëŠ” ë‹¤ìš´ë¡œë“œ ê°€ëŠ¥ ì‹œ ì •ìƒ(ë…¹ìƒ‰)ìœ¼ë¡œ í‘œì‹œ
                const statusClass = (isDesktopDownload && downloadAvailable) ? 'status-healthy' : (isDesktopDownload ? 'status-unknown' : (isHealthy ? 'status-healthy' : 'status-unhealthy'));
                let statusText = 'ë¹„ì •ìƒ';
                if (isDesktopDownload) statusText = downloadAvailable ? 'ë‹¤ìš´ë¡œë“œ ê°€ëŠ¥' : 'ì¤€ë¹„ ì¤‘';
                else if (isHealthy) statusText = 'ì •ìƒ';
                else if (service.enabled === false) statusText = 'ë¹„í™œì„±í™”';
                else if (health.error_message && health.error_message.startsWith('í—¬ìŠ¤ì²´í¬ ë¶ˆê°€')) statusText = 'í—¬ìŠ¤ì²´í¬ ë¶ˆê°€';

                const card = document.createElement('div');
                card.className = 'service-card';
                card.innerHTML = `
                    <div class="service-header">
                        <div class="service-name">${service.name}</div>
                        <div class="service-status ${statusClass}">${statusText}</div>
                    </div>
                    <div class="service-description">${service.description || 'ì„¤ëª… ì—†ìŒ'}</div>
                    <div class="service-info">
                        <span class="info-badge">${getTypeLabel(service.type)}</span>
                        ${(service.metadata?.tech || []).map(tech => 
                            `<span class="info-badge">${tech}</span>`
                        ).join('')}
                    </div>
                    ${health.error_message && !isDesktopDownload ? 
                        `<div style="color: #ef4444; font-size: 0.85em; margin-top: 10px;">âš ï¸ ${health.error_message}</div>` : ''}
                    ${isDesktopDownload ? 
                        `<div style="color: #64748b; font-size: 0.85em; margin-top: 10px;">ğŸ“¦ ë°ìŠ¤í¬í†± ë„êµ¬ - ë‹¤ìš´ë¡œë“œ í›„ ì„¤ì¹˜í•˜ì—¬ ì‚¬ìš©</div>` : ''}
                    <div class="service-actions">
                        ${isDesktopDownload ? 
                            (downloadAvailable ? 
                                `<a href="/api/download/${service.id}" class="btn btn-primary" download>ë‹¤ìš´ë¡œë“œ</a>` : 
                                `<span class="btn btn-secondary" style="opacity:0.7; cursor:not-allowed;">ì¤€ë¹„ ì¤‘</span>`) : ''}
                        ${service.base_url && isHealthy ? 
                            (() => { const u = (service.metadata?.direct_access && service.metadata?.port) ? (location.protocol + '//' + location.hostname + ':' + service.metadata.port + '/') : ('/api/' + service.id + '/'); return `<a href="#" class="btn btn-primary" data-service-url="${u.replace(/"/g, '&quot;')}" onclick="openServiceAccess(event, '${service.id}', this.dataset.serviceUrl)">ì„œë¹„ìŠ¤ ì ‘ì†</a>`; })() : ''}
                        ${service.api_prefix && isHealthy ? 
                            `<a href="/api/${service.id}/" class="btn btn-secondary" onclick="openApiAccess(event, '/api/${service.id}/')">API ì ‘ì†</a>` : ''}
                        ${service.api_prefix && userInfo.is_admin ? 
                            `<a href="/services/${service.id}/api-info" class="btn btn-secondary">API ì •ë³´</a>` : ''}
                        <a href="/services/${service.id}" class="btn btn-secondary">ìƒì„¸ ì •ë³´</a>
                    </div>
                `;
                grid.appendChild(card);
            });
        }

        async function openServiceAccess(event, serviceId, targetUrl) {
            event.preventDefault();
            try {
                const res = await fetch(`/api/check-service-access/${serviceId}`, { credentials: 'include' });
                if (!res.ok) {
                    alert('ì„œë¹„ìŠ¤ ì ‘ê·¼ì´ ë§‰í˜€ìˆìŠµë‹ˆë‹¤.');
                    return;
                }
                window.open(targetUrl, '_blank');
            } catch (err) {
                alert('ì„œë¹„ìŠ¤ ì ‘ê·¼ì´ ë§‰í˜€ìˆìŠµë‹ˆë‹¤.');
            }
        }

        async function openApiAccess(event, url) {
            event.preventDefault();
            try {
                const res = await fetch(url, { credentials: 'include' });
                if (!res.ok) {
                    const data = await res.json().catch(() => ({}));
                    alert(data.detail || 'API ì ‘ì†ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                    return;
                }
                window.location.href = url;
            } catch (err) {
                alert('API ì ‘ì† ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\n' + (err.message || ''));
            }
        }

        function getTypeLabel(type) {
            const labels = {
                'api': 'API',
                'web': 'ì›¹',
                'mobile': 'ëª¨ë°”ì¼',
                'desktop': 'ë°ìŠ¤í¬í†±',
                'microservice': 'ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤'
            };
            return labels[type] || type;
        }

        async function logout() {
            try {
                const response = await fetch('/api/auth/logout', {
                    method: 'POST',
                    credentials: 'include'
                });
                if (response.ok) {
                    window.location.href = '/';
                }
            } catch (error) {
                console.error('ë¡œê·¸ì•„ì›ƒ ì˜¤ë¥˜:', error);
                // ì˜¤ë¥˜ê°€ ë°œìƒí•´ë„ ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™
                window.location.href = '/';
            }
        }

        // ì´ˆê¸° ë¡œë“œ
        (function init() {
            var params = new URLSearchParams(window.location.search);
            if (params.get('error') === 'api_info_forbidden') {
                alert('API ì •ë³´ëŠ” ìµœê³  ê¶Œí•œ(ê´€ë¦¬ì) ê³„ì •ë§Œ ì ‘ê·¼í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
                window.history.replaceState({}, '', '/dashboard');
            }
            loadServices();
        })();

        // ìë™ ìƒˆë¡œê³ ì¹¨ (30ì´ˆë§ˆë‹¤)
        setInterval(loadServices, 30000);
    </script>
</body>
</html>
